// backend/src/orchestrator.ts
import OpenAI from 'openai';
import Anthropic from '@anthropic-ai/sdk';
import { GoogleGenerativeAI } from '@google/generative-ai';

interface LLMProvider {
  name: string;
  priority: number;
  isHealthy: boolean;
  call: (prompt: string, context: any) => Promise<string>;
}

export class MultiLLMOrchestrator {
  private providers: LLMProvider[];
  private openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
  private anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
  private google = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY);

  constructor() {
    this.providers = [
      {
        name: 'gpt-4o',
        priority: 1,
        isHealthy: true,
        call: this.callOpenAI.bind(this),
      },
      {
        name: 'claude-3.5-sonnet',
        priority: 2,
        isHealthy: true,
        call: this.callClaude.bind(this),
      },
      {
        name: 'gemini-1.5-pro',
        priority: 3,
        isHealthy: true,
        call: this.callGemini.bind(this),
      },
    ];

    // Health check a cada minuto
    setInterval(() => this.healthCheck(), 60000);
  }

  async getResponse({ customerId, message, context }: any) {
    const complexity = this.analyzeComplexity(message);

    // Roteamento inteligente baseado em complexidade
    let selectedProviders = this.providers;
    if (complexity === 'simple') {
      // Usar Gemini para queries simples (mais barato)
      selectedProviders = this.providers.filter(p => p.name === 'gemini-1.5-pro');
    }

    for (const provider of selectedProviders.sort((a, b) => a.priority - b.priority)) {
      if (!provider.isHealthy) continue;

      try {
        const prompt = this.buildPrompt(message, context);
        const response = await provider.call(prompt, context);

        return {
          content: response,
          modelUsed: provider.name,
          confidence: 0.95,
          suggestedActions: this.extractActions(response, context),
        };
      } catch (error) {
        console.error(`Provider ${provider.name} falhou:`, error);
        provider.isHealthy = false;
        continue;
      }
    }

    throw new Error('Todos os providers falharam');
  }

  private async callOpenAI(prompt: string, context: any): Promise<string> {
    const response = await this.openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: this.getSystemPrompt(context) },
        { role: 'user', content: prompt },
      ],
      temperature: 0.7,
    });

    return response.choices[0].message.content || '';
  }

  private async callClaude(prompt: string, context: any): Promise<string> {
    const response = await this.anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1024,
      system: this.getSystemPrompt(context),
      messages: [{ role: 'user', content: prompt }],
    });

    return response.content[0].type === 'text' ? response.content[0].text : '';
  }

  private async callGemini(prompt: string, context: any): Promise<string> {
    const model = this.google.getGenerativeModel({ model: 'gemini-1.5-pro' });
    const result = await model.generateContent([
      this.getSystemPrompt(context),
      prompt,
    ]);

    return result.response.text();
  }

  private getSystemPrompt(context: any): string {
    return `VocÃª Ã© o assistente virtual de um provedor de internet (ISP).

INFORMAÃ‡Ã•ES DO CLIENTE:
- Nome: ${context.customerName}
- Plano: ${context.currentPlan}
- Status da conexÃ£o: ${context.networkStatus}
- DÃ©bitos pendentes: ${context.hasPendingBills ? 'Sim' : 'NÃ£o'}

DIRETRIZES:
- Seja proativo, empÃ¡tico e eficiente
- OfereÃ§a soluÃ§Ãµes prÃ¡ticas com botÃµes de aÃ§Ã£o
- Se houver problema de rede, explique e dÃª previsÃ£o
- Para questÃµes financeiras, seja claro sobre valores e datas
- Sempre que possÃ­vel, resolva sem transferir para humano

AÃ‡Ã•ES DISPONÃVEIS:
- Abrir ticket tÃ©cnico
- Consultar faturas
- Agendar visita tÃ©cnica
- Alterar plano
- Segunda via de boleto`;
  }

  private analyzeComplexity(message: string): 'simple' | 'medium' | 'complex' {
    const simpleKeywords = ['oi', 'olÃ¡', 'obrigado', 'tchau', 'horÃ¡rio'];
    const complexKeywords = ['problema', 'nÃ£o funciona', 'reclamaÃ§Ã£o', 'cancelar'];

    const lower = message.toLowerCase();

    if (simpleKeywords.some(k => lower.includes(k))) return 'simple';
    if (complexKeywords.some(k => lower.includes(k))) return 'complex';

    return 'medium';
  }

  private extractActions(response: string, context: any): Action[] {
    // LÃ³gica para extrair aÃ§Ãµes sugeridas
    const actions: Action[] = [];

    if (response.includes('fatura') || response.includes('boleto')) {
      actions.push({ type: 'view_bill', label: 'ðŸ“„ Ver Fatura' });
    }

    if (response.includes('tÃ©cnico') || response.includes('visita')) {
      actions.push({ type: 'schedule_tech', label: 'ðŸ”§ Agendar TÃ©cnico' });
    }

    return actions;
  }

  private async healthCheck() {
    // Implementar ping simples em cada provider
    for (const provider of this.providers) {
      try {
        await provider.call('ping', {});
        provider.isHealthy = true;
      } catch {
        provider.isHealthy = false;
      }
    }
  }
}

06.md