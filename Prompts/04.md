// backend/src/server.ts
import express from 'express';
import { WebSocketServer } from 'ws';
import { MultiLLMOrchestrator } from './orchestrator';
import { ProactiveMonitor } from './proactive';

const app = express();
const server = app.listen(3001);
const wss = new WebSocketServer({ server });

const orchestrator = new MultiLLMOrchestrator();
const proactiveMonitor = new ProactiveMonitor();

wss.on('connection', async (ws, req) => {
  const customerId = authenticateWebSocket(req);

  console.log(`Cliente ${customerId} conectado`);

  // Enviar mensagem de boas-vindas
  ws.send(JSON.stringify({
    type: 'message',
    message: {
      id: crypto.randomUUID(),
      role: 'assistant',
      content: await orchestrator.getWelcomeMessage(customerId),
      timestamp: new Date(),
    }
  }));

  // Listener de mensagens do cliente
  ws.on('message', async (data) => {
    const payload = JSON.parse(data.toString());

    if (payload.type === 'chat') {
      // Indicador de digitação
      ws.send(JSON.stringify({ type: 'typing', isTyping: true }));

      try {
        const response = await orchestrator.getResponse({
          customerId,
          message: payload.content,
          context: await buildCustomerContext(customerId),
        });

        ws.send(JSON.stringify({
          type: 'message',
          message: {
            id: crypto.randomUUID(),
            role: 'assistant',
            content: response.content,
            timestamp: new Date(),
            metadata: {
              model: response.modelUsed,
              confidence: response.confidence,
              actions: response.suggestedActions,
            }
          }
        }));
      } catch (error) {
        ws.send(JSON.stringify({
          type: 'message',
          message: {
            id: crypto.randomUUID(),
            role: 'assistant',
            content: 'Desculpe, tive um problema. Pode tentar novamente?',
            timestamp: new Date(),
          }
        }));
      }
    }
  });

  // Sistema proativo - enviar alertas
  proactiveMonitor.on(`alert:${customerId}`, (alert) => {
    ws.send(JSON.stringify({
      type: 'proactive_alert',
      alert,
    }));
  });
});

// Iniciar monitoramento proativo
proactiveMonitor.start();

05.md